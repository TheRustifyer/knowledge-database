
# Home Assistant 🏡

[Home Assistant](https://www.home-assistant.io/) is an open source home automation software that puts local control and privacy first. Powered by a worldwide community of tinkerers and DIY enthusiasts.

## Installation

[Install](https://wiki.archlinux.org/title/Install "Install") the [home-assistant](https://archlinux.org/packages/?name=home-assistant) package. This is installing the core flavor of ***Home Assistant.***

```bash
sudo pacman -Syu home-assistant
```

### Copy an upgraded version of the daemon

```bash
sudo cp ~/.hosted/home_assistant/home-assistant.service /usr/lib/systemd/system/
```

## Configuration

Configuration files are stored at `/var/lib/hass/`. If no configuration exists, a default configuration will be written at startup.

## Usage

To start Home Assistant, [start/enable](https://wiki.archlinux.org/title/Start/enable "Start/enable") `home-assistant.service`.

```bash
sudo systemctl enable --now home-assistant.service
```

The first start may take up to 20 minutes because the required packages will be downloaded and installed.[[1]](https://www.home-assistant.io/docs/installation/) You can see the progress in the logs.

**Tip:** Follow the first-time update process using [journalctl](https://wiki.archlinux.org/title/Journalctl "Journalctl"):

```bash
journalctl -fu home-assistant
```

By default, the web interface is available [here](https://assistant.home.lab)

# Troubleshooting

## Add TAPO integrations

In the Tapo app, go to **Me > Tapo Lab > Third-Party Compatibility** and enable it. Then, set up a local camera account under **Advanced Settings > Camera Account** and use these credentials in Home Assistant instead of your TP-Link cloud credentials.

## Docker DNS error

> [!info]
>This one applies when the container network is in `host` mode.

This is produced because the container creates an incorrect `/etc/resolv.conf` file from the host. For example, my host `/etc/resolv.conf` file was generated saying that the `nameserver` was `192.168.10.95`, which was correct for some time, until I rebooted everything, changed my home and setup a new networking.

Fix is easy. Just edit the `/etc/docker/daemon.json` and add the following:

```json
{
  "dns": ["127.0.0.1"]
}
```

> [!warning]
> `127.0.0.1` is the value when the container is in **host** mode. Otherwise, you'll need to put the address of the server that is running your private DNS resolver.
### The `/var/lib/hass` -> `private/hass` symlink

The `Arch` *PKGBUILD* comes with that configuration, such that installs in `/var/lib/private` and then symlinks to `/var/lib/hass`

```bash
┌─>   vv at  vv-minipc in @192.168.10.95 ~ took 3s
✦ ❯ sudo ls -lah /var/lib/hass
lrwxrwxrwx 1 root root 12 abr  2 11:32 /var/lib/hass -> private/hass

┌─>   vv at  vv-minipc in @192.168.10.95 ~
✦ ❯ sudo ls -lah /var/lib/private/hass
total 364K
drwxr-xr-x 10 hass hass 4,0K abr 18 00:47 .
drwx------  4 root root 4,0K abr  2 11:32 ..
-rw-r--r--  1 hass hass    2 mar 31 22:44 automations.yaml
drwxr-xr-x  4 hass hass 4,0K mar 31 22:44 blueprints
drwxr-x---  5 hass hass 4,0K mar 31 22:44 .cache
drwxr-xr-x  2 hass hass 4,0K mar 31 22:44 .cloud
drwx------  2 hass hass 4,0K mar 31 22:44 .config
-rw-r--r--  1 hass hass 2,9K may  4 10:54 configuration.yaml
drwxr-xr-x  2 hass hass 4,0K mar 31 22:44 deps
-rw-r--r--  1 hass hass    8 mar 31 22:44 .HA_VERSION
-rw-r--r--  1 hass hass 296K abr  1 10:28 home-assistant_v2.db
-rwxr-xr-x  1 hass hass 2,7K abr  2 11:32 lldap_ha_auth.sh
-rw-r--r--  1 hass hass    0 mar 31 22:44 scenes.yaml
-rw-r--r--  1 hass hass    0 mar 31 22:44 scripts.yaml
-rw-r--r--  1 hass hass  109 abr  1 10:34 secrets.yaml
-rw-r--r--  1 hass hass  109 abr  1 10:28 secret.yaml
-rwxr-x---  1 root root 3,2K abr 12 10:14 ssl
drwxr-xr-x  2 hass hass 4,0K abr  2 11:36 .storage
drwxr-xr-x  2 hass hass 4,0K mar 31 22:44 tts
drwxr-x---  7 hass hass 4,0K mar 31 22:50 .venv
```

> [!info]
> One possible solution **(if this is a problem)** is to get rid out of the *symlink* and move all the content under `/var/lib/hass`.

### Fixing the `Arch Linux` script installation

> [!info]
> By default, the installation script isn't working. But the provided *daemon* file from the dotfiles should fix most of the problems, but not all, since we need to fix the permissions on the installation dir first. So let's go fix it.

### 🔥 Fix it by resetting permissions and disabling DynamicUser

#### 1️⃣ Stop the Service

```bash
sudo systemctl stop home-assistant
```

#### 2️⃣ Disable DynamicUser

Since `DynamicUser=true` prevents permanent ownership, we need to remove it. Open the service file:

```bash
sudo nano /usr/lib/systemd/system/home-assistant.service
```

Find this line: `DynamicUser=true`

#### ❌ Remove or comment it out (#DynamicUser=true).

```txt
User=hass
Group=hass
StateDirectoryMode=0755
```

✅ Then save & exit (CTRL+X, Y, ENTER).

#### 3️⃣ Reset Permissions

```bash
sudo chown -R hass:hass /var/lib/hass
sudo chmod -R 750 /var/lib/hass
sudo chown -R hass:hass /var/log/hass
sudo chmod -R 750 /var/log/hass
```

#### 4️⃣ Reload Systemd & Restart

```bash
sudo systemctl daemon-reload
sudo systemctl restart home-assistant
```

Then check logs again:

```bash
journalctl -fu home-assistant
```

## In case that some folder is just owned by Nobody`

### 1️⃣ Check permissions and owner again

Execute the following to ensure that `hass` really has the correct permissions:

```bash
sudo ls -lah /var/lib/hass/.venv/
```

2️⃣ If `nobody:nobody` is yet the owner, force the ownership change again:

``` bash
sudo chown -R hass:hass /var/lib/hass
sudo chmod -R 750 /var/lib/hass

sudo chown -R hass:hass /var/log/hass
sudo chmod -R 750 /var/log/hass
```

> [!warning]
> The last time I check this I had that strange issue, where the owner didn't change recursevely in all the directories. Repeat the change solve the issue magically. Kinda strange, but shit happens.

## ModuleNotFoundErrors in logs

If Home Assistant is broken after a system package upgrade, it could be caused by a bad interaction between the system packages and Home Assistant's managed Python libraries. To reset Home Assistant's Python libraries and reinstall them from scratch, delete the modules directory:

```bash
rm -r /var/lib/hass/deps/lib
```

Then [restart](https://wiki.archlinux.org/title/Restart "Restart") `home-assistant.service`.

If the first restart produces more `ModuleNotFoundErrors`, it might be necessary to a second restart. Home Assistant will detect that its modules are missing and automatically reinstall them.

### Speech-to-phrase custom init script

This container needs to be working with `SSL` in the *ws* uri. That means that we need to load the `self-signed` certs into the container. For that, there's an script that is mounted into the container from host, but we need to ensure that we make it executable or it will fail

```bash
┌─>   vv at  vv-minipc in @192.168.10.95 ~ took 11s
✦ ❯ chmod +x .hosted/home_assistant/speech-to-phrase-entrypoint.sh
```

## 🛣️ Nginx as reverse proxy

> [!tip]
> Just copy the `configuration.yaml` file from the dotfiles

```bash
sudo cp -f ~/.hosted/home-assistant/configuration.yaml /var/lib/hass
```

### Configure Home Assistant for reverse proxy (explanation)

Home Assistant is still available without using the NGINX proxy. Restricting it to only listen to `127.0.0.1` will forbid direct accesses.  
Also, Home Assistant should be told to only trust headers coming from the NGINX proxy. Otherwise, incoming requests will always come from `127.0.0.1` and not the real IP address.

In your `configuration.yaml` file, edit the `http` setting.

```yaml
http:
  # For extra security set this to only accept connections on localhost if NGINX is on the same machine
  # Uncommenting this will mean that you can only reach Home Assistant using the proxy, not directly via IP from other clients.
  # server_host: 127.0.0.1
  use_x_forwarded_for: true
  # You must set the trusted proxy IP address so that Home Assistant will properly accept connections
  # Set this to your NGINX machine IP, or localhost if hosted on the same machine.
  trusted_proxies: <NGINX IP address here, or 127.0.0.1 if hosted on the same machine>
```

```
## Backup Notes

The Backup restore function is not available in the UI. The backup can be restored by extraction of the tar.gz file in the Backup as user hass:

```bash
tar --strip-components=1 -xzf homeassistant.tar.gz -C /var/lib/hass
```

## Using PostgreSQL

You need to install the python module called _psycopg2_ into the venv of hass. Luckily for you, it's already included in the **daemon** script, so there's no need for do anything else.

```bash

```

### [Database startup](https://www.home-assistant.io/integrations/recorder#database-startup)

> [!warning]
> If you are running a database server instance on the same server as Home Assistant then you must ensure that this action starts before Home Assistant. For a Linux instance running Systemd (Raspberry Pi, Debian, Ubuntu and others) you should edit the service file. To help facilitate this, db_max_retry and db_retry_wait variables have been added to ensure the recorder retries the connection to your database enough times, for your database to start up.

```bash
sudo nvim /etc/systemd/system/home-assistant@homeassistant.service
```

And add the action for the database, for example, PostgreSQL:

```txt
[Unit]
Description=Home Assistant
After=network.target postgresql.service
```

Save the file then reload `systemctl`:

```bash
sudo systemctl daemon-reload
```

> [!note]
> As you may guess, this is also included in the `home-assistant.service` daemon file

# Home Assistant Supervised 🔎

```bash
yay -S homeassistant-supervised
sudo systemctl enable --now hassio-apparmor.service
sudo systemctl enable --now hassio-supervisor.service
```

# [LDAP integration](https://github.com/lldap/lldap/blob/main/.github/CODEOWNERS#L1) 🔐

Home Assistant configures ldap auth via the [Command Line Auth Provider](https://www.home-assistant.io/docs/authentication/providers/#command-line). The wiki mentions a script that can be used for LDAP authentication, but it doesn't work in the container version (it is lacking both `ldapsearch` and `curl` ldap protocol support). Thankfully ***LLDAP*** has a graphql API to save the day!

## [Graphql-based Auth Script](https://github.com/lldap/lldap/blob/main/example_configs/home-assistant.md#graphql-based-auth-script)

The [auth script](https://github.com/lldap/lldap/blob/main/example_configs/lldap-ha-auth.sh) attempts to authenticate a user against an LLDAP server, using credentials provided via `username` and `password` e

nvironment variables. The first argument must be the URL of your LLDAP server, accessible from Home Assistant. You can provide an additional optional argument to confine allowed logins to a single group. The script will output the user's display name as the `name` variable, if not empty.

1. Copy the [auth script](https://github.com/lldap/lldap/blob/main/example_configs/lldap-ha-auth.sh) to your home assistant instance. In this example, we use `/config/lldap-ha-auth.sh`.
    - Set the script as executable by running `chmod +x /config/lldap-ha-auth.sh`
    - If your lldap reverse proxy is using a local (insecure) certificate, you have to add `-k` to the `curl` commands
2. Add the following to your configuration.yaml in Home assistant:

```yaml
homeassistant:
  auth_providers:
    # Ensure you have the homeassistant provider enabled if you want to continue using your existing accounts
    - type: homeassistant
    - type: command_line
      command: /config/lldap-ha-auth.sh
      # arguments: [<LDAP Host>, <regular user group>, <admin user group>, <local user group>]
      # <regular user group>: Find users that has permission to access homeassistant, anyone inside
      # this group will have the default 'system-users' permission in homeassistant.
      #
      # <admin user group>: Allow users in the <regular user group> to be assigned into 'system-admin' group.
      # Anyone inside this group will not have the 'system-users' permission as only one permission group
      # is allowed in homeassistant
      #
      # <local user group>: Users in the <local user group> (e.g., 'homeassistant_local') can only access
      # homeassistant inside LAN network.
      #
      # Only the first argument is required. ["https://lldap.example.com"] allows all users to log in from
      # anywhere and have 'system-users' permissions. 
      args: ["https://lldap.example.com", "homeassistant_user", "homeassistant_admin", "homeassistant_local"]
      meta: true
```

3. Restart Home Assistant

# # [Self-signed SSL certificate trust option for the mobile app login](https://community.home-assistant.io/t/self-signed-ssl-certificate-trust-option-for-the-mobile-app-login/576351)

Just upload the `*.crt` file to your *Android* phone and load the certificate from the phone/tablet `Settings`. The option may be located under `Settings > Wi-Fi > Install Certificates`.

# # Downloading HACS

This section shows how to download HACS to your Home Assistant and how to troubleshoot some common issues.

## To download [HACS](https://hacs.xyz/docs/use/download/download/#to-download-hacs)

How you download HACS depends on your Home Assistant installation type. In the instructions below, select the tab that matches your installation type (OS/Supervised, Container, or Core).

Warning

If you don't know what type of Home Assistant installation you are running, you should not use HACS (or any other custom integration).

[OS/Supervised](https://hacs.xyz/docs/use/download/download/#to-download-hacs-ossupervised)[Container](https://hacs.xyz/docs/use/download/download/#to-download-hacs-container)[Core](https://hacs.xyz/docs/use/download/download/#to-download-hacs-core)

To set up HACS, you can use the [HACS download script](https://github.com/hacs/get).

1. Open a terminal.
2. Go inside the container with `docker exec -it <name of the container running homeassistant> bash`.
3. Run the HACS download script.
4. `wget -O - https://get.hacs.xyz | bash -`

### Finalizing steps[¶](https://hacs.xyz/docs/use/download/download/#finalizing-steps "Permanent link")

1. Restart Home Assistant.
2. Follow the steps on [setting up the HACS integration](https://hacs.xyz/docs/use/configuration/basic/).

# [Vikunja HACS integration](https://github.com/joeShuff/vikunja-homeassistant/?tab=readme-ov-file)🦙

// TODO

# Voice control - Atom M5

Setting up the Atom M5 is extremely easy. First go to [this page]([$13 voice assistant for Home Assistant - Home Assistant](https://www.home-assistant.io/voice_control/thirteen-usd-voice-remote/)

> [!warning]
> The link above must be opened in a `chromium` based browser, otherwise, it will complain
> about it

Then, connect your `M5` on a USB of your computer.

Now look for the `Connect` blue button 

Now click on the Install one:

![[Pasted image 20250504130957.png]]

## The web based installer 

An installer should run on the web browser, connected via `Serial` (TTY over USB),
which will flash the `Home Assistant` configuration on the `M5 Atom` firmware

![[Pasted image 20250504131134.png]]

## Configuring the Wi-Fi

When ends, you'll be prompted to `Configure your Wi-FI`

![[Pasted image 20250504131330.png]]

## Adding the device to HA

Click on: `Add to Home Assistant`

![[Pasted image 20250504131638.png]]

Now, look for the `IP` that probably your router asigned to the device via `DHCP`.
When you have it, complete the `HA` prompt that asks you for the **Host:Port** combination.

## Adding Wyoming entities to HA

In order to integrate the `speech-to-text`, `text-to-speech` and the `wakeword` into the `HA` smart assistants and voice assistants, we need to add the `Wyoming protocol integration` and add those integrations with the `Host:Port` of everyone of them.

Then, go to the `Voice Assistants` tab on the `Settings` page and configure a new *voice assistant* with the discovered entities.

![[Pasted image 20250504133357.png]]

# Known (already happened) errors

## Invalid config for 'http' (ssl certificate)

```bash
┌─>   vv at  vv-minipc in @192.168.1.10 ~ via  v3.13.3
❯ sudo /var/lib/hass/.venv/bin/hass \
  --config /var/lib/hass/ \
  --log-file /var/log/hass/home-assistant.log \
  --log-rotate-days 1
2025-07-03 16:44:53.507 ERROR (MainThread) [homeassistant.config] Invalid config for 'http' at configuration.yaml, line 41: not a file for dictionary value 'http->ssl_certificate', got '/usr/share/hassio/ssl/home.lab.crt', please check the docs at https://www.home-assistant.io/integrations/http
Invalid config for 'http' at configuration.yaml, line 42: not a file for dictionary value 'http->ssl_key', got '/usr/share/hassio/ssl/home.lab.key', please check the docs at https://www.home-assistant.io/integrations/http
2025-07-03 16:44:53.507 ERROR (MainThread) [homeassistant.setup] Setup failed for 'http': Invalid config.
```

Probably the certs has been moved from the location that are being referenced in the `configuration.yaml` file.

Just change them and point them to the correct direction. Take care with permissions due to the `hass` user if applies.