AdBlocker and DNS Server, meet your new favourite tool in the world.

Apart from being an extremely efficient *AdBlocker*... bla bla

## Install AdGuard

```bash
sudo pacman -S adguardhome
sudo adguardhome -s install
```

Now, `AdGuardHome` should be served on your machine's ip on **port 3000**. This web-ui shows the installation of `AdGuardHome` from a graphical interface.

![[adguard-install-screen-step-1.png]]

### Removing system-daemon from resolving DNS on port 53

On `Manjaro`, the port *53* will be used for *systemd-resolved*, which acts as your `DNS` resolver. `AdGuardHome` needs to bind to the port *53* in order to do it's job properly.

Copy and paste the snippet below to solve this issue before going further on our installation

```bash
sudo mkdir -p /etc/systemd/resolved.conf.d
sudo tee /etc/systemd/resolved.conf.d/adguardhome.conf <<EOF
[Resolve]
DNS=127.0.0.1
DNSStubListener=no
EOF

sudo mv /etc/resolv.conf /etc/resolv.conf.backup
sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf

sudo systemctl stop systemd-resolved
sudo systemctl reload-or-restart systemd-resolved

# sudo systemctl unmask adguardhome.service
sudo systemctl daemon-reload
sudo systemctl enable --now adguardhome.service
sudo systemctl start adguardhome.service
sudo systemctl status adguardhome.service
```

### Admin web ui and DNS Server

Let's continue with the installation. I use a custom port for `AdGuardHome`, the **1001**, to let free the port **80** to be used for plain `http` requests (that will be proxied by ***Nginx** in the future).

![[adguard-web-ifc-dns-server-screen.png]]

### Admin user and password

Choose a *username* and a *password* for your admin Adguard's instance.

### Configure your devices

All of our configuration will be directly on the router, giving our machine's address to resolve the `DNS` queries, so no further action will be needed.

### Last installation screen

![[adguard-install-complete.png]]

## Configuring the basics of AdGuardHome

![[adguard-general-settings.png]]

### Enable the `Use Safe Search` on all the search engines

Pretty self-explainatory

### DNS Settings

![[DNS Settings.png]]

On the `Upstream DNS servers` box, enter the following:

```plain-text
https://dns10.quad9.net/dns-query
https://adblock.dns.mullvad.net/dns-query
https://base.dns.mullvad.net/dns-query
https://dns10.quad9.net/dns-query
tls://dns10.quad9.net
https://dns11.quad9.net/dns-query
tls://dns.quad9.net
```

#### Ensure that `Load-balancing` is set as the method to query the upstream servers

#### Set `Upstream Timeout` to 5 seconds

### Encryption

// TODO:

### DNS Rewrites

Here's where the other part of the AdGuardHome magic happens

![[adguard-dns-rewrites.png]]

And complete the following mappings in the rewrites
![[adguard.dns.rewrites.png]]


## BlockLists

Now's time to reveal the true power of `AdGuard`.

Under the filter section you'll find the `blocklists` entry, and `allowlists`.

Behaviour and configuration in my case is extremely simple. I just add ***all the lists*** and then manually I'll add all the blocked hosts that I need to be unblocked. Yes, it's more effort, but by default no `url` that doesn't need to be queried w'd be, so you can manually start to unblock the real urls that you need access to and deny all the others.

![[adguard-blocklists.png]]